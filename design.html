<html>
    <style type="text/css" id="night-mode-pro-style"></style>
    <link type="text/css" rel="stylesheet" id="night-mode-pro-link">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Team 8 UCL">

    <title>iPoorly</title>
    <meta name="description" content="Team 8 UCL Systems Engineering project for ASKSNIFF.">
    <link rel="icon" href="img/fav.ico" type="image/x-icon">

    <!-- Bootstrap Core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">

    <!-- Theme CSS -->
    <link href="css/freelancer.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

    <style>
        body{
            height: 100%;
        }
        table{
            border-collapse: collapse;
            border-spacing: 0;
            border:2px solid #000000;
        }
        th{
            border:2px solid #000000;
            padding: 10px;
        }

        td{
            border:1px solid #000000;
            padding: 10px;
        }
        nav > div > div > ul > li > a.active{
            background: #18BC9C;
        }
        .carousel-indicators li{
            background-color: black;
        }
    </style>
</head>
<body id="page-top">
    <nav id="mainNav" class="navbar navbar-default navbar-fixed-top navbar-custom">
        <div class="container">
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span> Menu <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand" href="#page-top">iPoorly</a>
            </div>
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                    <li class="page-scroll">
                          <a href="index.html">Home</a>
                      </li>
                      <li class="page-scroll">
                          <a href="requirements.html">Requirements</a>
                      </li>
                      <li class="page-scroll">
                          <a href="research.html">Research</a>
                      </li>
                      <li class="page-scroll">
                          <a href="hci.html">HCI</a>
                      </li>
                      <li class="page-scroll">
                          <a class="active" href="design.html">Design</a>
                      </li>
                      <li class="page-scroll">
                          <a href="testing.html">Testing</a>
                      </li>
                      <li class="page-scroll">
                          <a href="evaluation.html">Evaluation</a>
                      </li>
                      <li class="page-scroll">
                          <a href="management.html">Management</a>
                      </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="site-content">
        <div class="wrapper container-fluid">
            <div class="row">
                <div class="col-md-3">
                    <nav id="table-of-contents" class="affix">
                        <ul class="nav headings">
                            <li class="active"><a href="#system-architecture">System Architecture</a></li>
                            <li><a href="#class-diagram">Class Diagram</a></li>
                            <li><a href="#continuous-integration">Continuous Integration</a></li>
                            <li><a href="#docker-machine">Docker Machine</a></li> 
                            <li><a href="#design-pattern">Design Patterns</a></li>
                            <li><a href="#data-storage">Data Storage</a></li> 
                            <li><a href="#analytics">Analytics</a></li>  
                            <li><a href="#implementation-of-key-functionalities">Implementation of Key Functionalities</a></li>  
                            <li><a href="#references">References</a></li>                       
                        </ul>
                    </nav>
                </div>
                <div class="col-md-9">    
                    <h1>Introduction</h1>
                    <p>This section aims to discuss the design aspect of our project. It looks at the overall system architecture and class diagram of our project. We've also included the design patterns that were implemented in our project. Other than that, it looks at how data storage for our website works and also how the key functionalities of our website were implemented.</p>

                    <h1 id="system-architecture">System Architecture</h1>
                    <figure><img src="img/system_arc1.png" class="center-block" width="100%"><figcaption class="text-center">Fig 1.1 - Single Instance</figcaption></figure>
                    <p>Brief description of the components that are in the system architecture diagram below:</p>
                    <p><b>HAProxy</b> - The load balancer. It distributes the load coming into the website between the different instances of the django application</p>
                    <p><b>Apache Web Server</b> - Used to serve static files and handle requests coming to the website from the load balancer.</p>
                    <p><b>Django</b> - The backend of the website. Framework that sends the correct response for each request made to the website.</p>
                    <p><b>Azure Storage</b> -  Used to store the media files such as images. Does not increase the load for the apache server and also reduces the storage capacity required to host the website.</p>
                    <p><b>Google Maps</b> - Used to get nearby hospitals from the current location of the user.</p>
                    <p><b>Memcache</b> - Used to cache expensive database queries that are used often (same information used many times) such as information on a symptom for a certain age group. This improves the website's efficiency and speed and has less stress on the backend and database.</p>
                    <p><b>PostgresSQL</b> - The database server used to store the website's data/information</p>
                    <br>
                    <p>The follow diagram shows what the system architecture diagram looks like when scaled up to 3 instances:-</p>
                    <figure><img src="img/system_arc2.png" class="center-block" width="100%"><figcaption class="text-center">Fig 1.2 - Scaled Up to 3 Instances</figcaption></figure>
                                       
                    <h1 id="class-diagram">Class Diagram</h1>
                    <p>Class diagram of our website</p>
                    <figure><img src="img/classdiagram.jpg" class="center-block" width="100%"><figcaption class="text-center">Fig 2.1 - Class Diagram</figcaption></figure>
                                            
                    <h1 id="continuous-integration">Continuous Integration</h1>
                    <p>The diagram below shows our continuous intergration pipeline</p>
                    <figure><img src="img/ci.png" class="center-block" width="100%"><figcaption class="text-center">Fig 3.1 - Continuous Integration Pipeline</figcaption></figure>
                                        
                    <h1 id="docker-machine">Docker Machine</h1>
                    <p>The website was deployed inside a docker enviroment which was on a linux server. Below is a diagram showing our docker enviroment</p>
                    <figure><img src="img/docker.png" class="center-block" width="100%"><figcaption class="text-center">Fig 4.1 - Docker Enviroment</figcaption></figure>

                    <h1 id="design-pattern">Design Patterns</h1>
                    <h3>Model - View - Controller</h3>
                    <p>Model–view–controller (MVC) is an architectural pattern commonly used for developing user interfaces that divides an application into three interconnected parts, the model, the view and the controller. Django follows the Model View Template concept which is similar to the Model-View-Controller pattern. The difference is that the template in mtv is the same as the view in MVC and the view in MVT is the same as the controller in MVC. The model handles the data and any logic associated with the data such as validation, how to access the data and the relationships between the data. The model code can be found in model.py. Instead of a controller django has something called a template. The template contains the presentation of the website (like the view of the website). This includes how something should be shown on a website. There can be multiple templates for different presentations. The templates can be found under the templates folder. The view contains the logic behind the application (something like a controller). The view contains the logic that accesses the information from a database and populates the data onto an appropriate template. It is the bridge between the model and template. The code for the view can be found in the views.py file.</p>

                    <h3>Query Object</h3>
                    <p>Query objects are objects that represent a database SQL query. To prevent the use of SQL queries, we use specialized finder methods that hide the SQL inside parameterized methods of criteria objects. The criteria objects will contain the operator for the SQL (=,>,<), the field to search from and the value to search from. This ensures that developers dont need to know SQL as a language to use the database. The query objects is an interpreter for all the criteria objects. It links the criteria objects into one big query. Through the use of query objects we can create queries by referring to classes and fields rather than tables and columns.</p>
                    
                    <h3>Template Method</h3>
                    <p>The template method pattern is a behavioural design pattern that defines the "program skeleton of an algorithm in an operation deferring some steps to client subclasses". It allows subclasses to redefine steps of the algorithm without changing the algorithm structure and without having a completely different copy of the similar algorithm.<br> For our website, the skeleton code is our static html and markers used as placeholders is our client subclass. When the html page is requested, django replaces the markers with the appropriate data from the model and returns the generated HTML to the user. The views send the data to replace the markers in the template as a dictionary where the key is the marker name and the value is the value that will replace the marker. The markers in the html pages look like this <code>{{marker name}}</code>. An example is: <code>Hello {{username}}</code>The views would send the data in the following format <code>{‘username’:’john’}</code>. The rendered html file will be <code>Hello john</code></p>

                    <h3>Active Record</h3>
                    <p>The active record pattern is an architectural pattern found in software that stores in-memory object data in relational databases.In this pattern a database table is wrapped into a class and an object of the class is a row of the table. So creating an object creates a new row in the table, updating the object updates that row and deleting the object deletes the row. The object will carry both the data of the row and also some behaviour. This approach makes the data easier to read, use and edit. If a column in a row has a relation with another table, the data of that column will be an object of the appropriate row(s) of the table it has a relationship with. In our website we use this pattern to update, create and add data into our table</p>

                    <h3>Decorator Pattern</h3>
                    <p>the decorator pattern is a design pattern that allows behavior to be added to an individual object, either statically or dynamically, without affecting the behavior of other objects from the same class. In our website we decorate a view function with decorators. For some views a login is required. To ensure that the user is logged in before they can see a view, we can decorate the view the user wishes to see with a login_required decorator. This acts as a wrapper around the view function and only executes the view function if a user is logged in. We can remove the decorator from the view if the view does not require a logged in user. We did similar things with disclaimer_read which checks if a user has read the disclaimer and agreed to the disclaimer before they can access the website. The code for the decorators can be found in decorators.py. To use a decorator simply add <code>@decorator_name</code> ,which is a syntatic sugar for the decorator, at the start of the function you want to wrap the decorator around.</p>

                    <h1 id="data-storage">Data Storage</h1>
                    <p>Below is a database schema diagram of our postgres database</p>
                    <figure><img src="img/db.png" class="center-block" width="100%"><figcaption class="text-center">Fig 5.1 - Database Schemea</figcaption></figure>


                    <h1 id="analytics">Analytics</h1>
                    <p>Our client wanted some way to get analytics about the website such as how many users are visiting the website to how much time they spend on the website. For this the team decided to use Google Analytics. Google Analytics is easy to set up and the report panel is very informative. It is a very popular and respected tool which records information accurately. The information that is generated from Google Analytics include:</p>
                    <ul>
                        <li>How many users visited the website</li>
                        <li>How long each user interacted with the website</li>
                        <li>Number of current active users (how many people are currently using the website)</li>
                        <li>The times of when users visit the website</li>
                        <li>Where the users are from</li>
                        <li>What devices users are using to access the website</li>
                        <li>Frequency of the number of visitors for each web page of the website.</li>
                    </ul>
                    <p>Below are a few images from our Google Analytics admin pages of the website</p>
                    <div id="analytics-carousel" class="carousel slide" data-ride="carousel">
                        <ol class="carousel-indicators">
                          <li data-target="#analytics-carousel" data-slide-to="0" class="active"></li>
                          <li data-target="#analytics-carousel" data-slide-to="1"></li>
                          <li data-target="#analytics-carousel" data-slide-to="2"></li>
                        </ol>
                    
                        <!-- Wrapper for slides -->
                        <div class="carousel-inner">
                          <div class="item active">
                            <img src="img/google1.png" style="width:100%;">
                          </div>
                    
                          <div class="item">
                            <img src="img/google2.png" style="width:100%;">
                          </div>
                        
                          <div class="item">
                            <img src="img/google3.png" style="width:100%;">
                          </div>
                        </div>
                    
                        <!-- Left and right controls -->
                        <a class="left carousel-control" data-target="#analytics-carousel" data-slide="prev" onclick="$('#analytics-carousel').carousel('prev')">
                          <span class="glyphicon glyphicon-chevron-left"></span>
                        </a>
                        <a class="right carousel-control" data-target="#analytics-carousel" data-slide="next" onclick="$('#analytics-carousel').carousel('next')">
                          <span class="glyphicon glyphicon-chevron-right"></span>
                        </a>
                    </div>

                    <h1 id="implementation-of-key-functionalities">Implementation of Key Functionalities</h1>
                    <h2>Search</h2>
                    <p>The search query is received through an ajax call from the search page. The query is first checked to make sure it's not too long (if it is long it is broken down). It is also checked to ensure no malicious code is being sent (like a script). Once it is cleaned, the query string is run through the cache to check if someone has already searched this query. If it matches a query in the cache the result from the cache is obtained, converted to json and returned to the ajax call. If it doesn't exist in the cache, then the query is searched through the database. The results received are then converted to json and sent back. Here is the query code to get relevant subheadings:</p>
                    <div style="background:#f9f2f4">
                        <code>
                            sub_headings = SubHeading.objects.filter((Q(headingId__text__icontains=query) | Q(headingId__categoryName__categoryName__icontains=query) |Q(text__icontains=query)) & Q(ageGroup__age_group=age_group)).distinct()<br>
                            data = []<br>
                            for sub_heading in sub_headings:<br>
                            &emsp;&emsp;&emsp;&emsp;title = str(sub_heading.title)<br>
                            &emsp;&emsp;&emsp;&emsp;text = str(sub_heading.text)<br>
                            &emsp;&emsp;&emsp;&emsp;heading_id = str(sub_heading.headingId.headingId)<br>
                            &emsp;&emsp;&emsp;&emsp;sub_heading_id = str(sub_heading.subHeadingId)<br>
                            &emsp;&emsp;&emsp;&emsp;data_dictonary = {'title':title, 'text':text, 'heading_id':heading_id, 'sub_heading_id':sub_heading_id}<br>
                            &emsp;&emsp;&emsp;&emsp;data.append(data_dictonary)<br>
                            return JsonResponse(data)
                        </code>
                    </div>
                    <h2>Delete Child Profile</h2>
                    <p>Deletion and activation of a child are done through ajax post calls only with a secret ID. This ensures that the activation and deletion can only be made from the appropriate page. When a request is made to delete a child, the request id must match the id of the user whose child is being deleted. If it doesn't match a json response, a failure is sent back. If the ID matches, the child is checked to see if it was a currently used child. If so the child is deleted and the next child in the user's account is activated. If the user does not have any more children (deleted their last child) they are redirected to the add child page</p>
                    <div style="background:#f9f2f4">
                        <code>
                            if child.username != request.user:<br>
                            &emsp;&emsp;&emsp;&emsp;return JsonResponse({'status':0})<br>
                            if child.activate:<br>
                            &emsp;&emsp;&emsp;&emsp;child.delete()<br>
                            &emsp;&emsp;&emsp;&emsp;new_child = Child.objects.filter(username=request.user).first()<br>
                            &emsp;&emsp;&emsp;&emsp;new_child.activate = True<br>
                            &emsp;&emsp;&emsp;&emsp;new_child.save()<br>
                            else:<br>
                            &emsp;&emsp;&emsp;&emsp;child.delete()<br>
                            return JsonResponse({'status':1})                        
                        </code>
                    </div>
                    <h2>Displaying data according to User (dynamic data)</h2>
                    <p>Each symptom information has an age group linked to it. For users that have skipped login, they need to select an age group. From that point onwards, the backend just selects the symptom information linked to the age group selected. For a logged in user, we first check if they have a child in their account. If not they should add a child. If they have a current active child, we get that child's age and calculate their age in months. We then get the appropriate age group depending on their age in months and save that so we don't need to calculate again. The calculation:</p>
                    <div style="background:#f9f2f4">
                        <code>
                            age_group_of_child = agegroup(((date.today().year - child_age.year)*12) + (date.today().month - child_age.month))
                        </code>
                    </div>
                    <h2>Download Information</h2>
                    <p>When the user clicks on the print information button, a js script gets all the information on that page (the title, content and images), creates a html document from the information with a few custom stylings and then sends it to the browser's print option. The user can then print it or save it as a pdf.</p>
                    <h2>Upload image for a diary log</h2>
                    <p>When a user attaches an image to a diary log, the image is transferred to the azure storage while they are still writing the context of the log. This ensures that when they click on add, they don't have to wait long for the image to be uploaded to the server. However the image is stored in a temporary folder. If a user clicks on cancel, the image is deleted from the storage. If a user clicks on Add log then the image is moved from the temporary storage to their storage folder location.</p>
                    
                    <h1 id="references">References</h1>
                    <p>[1]"Model–view–controller", En.wikipedia.org, 2018. [Online]. Available: https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller. [Accessed: 08- Mar- 2018].</p>
                    <p>[2]"P of EAA: Query Object", Martinfowler.com, 2018. [Online]. Available: https://martinfowler.com/eaaCatalog/queryObject.html. [Accessed: 08- Mar- 2018].</p>
                    <p>[3]"Design Patterns and Refactoring", Sourcemaking.com, 2018. [Online]. Available: https://sourcemaking.com/design_patterns/template_method. [Accessed: 08- Mar- 2018].</p>
                    <p>[4]"Active record pattern", En.wikipedia.org, 2018. [Online]. Available: https://en.wikipedia.org/wiki/Active_record_pattern. [Accessed: 08- Mar- 2018].</p>
                    <p>[5]A. Farhat, "A guide to Python's function decorators", The Code Ship, 2018. [Online]. Available: https://www.thecodeship.com/patterns/guide-to-python-function-decorators/. [Accessed: 08- Mar- 2018].</p>
                </div>
                 <!-- modal for image enlarge -->
                <div class="modal fade" id="enlargeImageModal" tabindex="-1" role="dialog" aria-labelledby="enlargeImageModal" aria-hidden="true">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                        </div>
                        <div class="modal-body">
                            <img src="" class="enlargeImageModalSource" style="width: 100%;">
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center" style="margin-bottom: 0px;">
        <div class="footer-below">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        Copyright &copy; iPoorly 2018
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scroll to Top Button (Only visible on small and extra-small screen sizes) -->
    <div class="scroll-top page-scroll hidden-sm hidden-xs hidden-lg hidden-md">
        <a class="btn btn-primary" href="#page-top">
            <i class="fa fa-chevron-up"></i>
        </a>
    </div>

    <!-- jQuery -->
    

    <!-- Bootstrap Core JavaScript -->
    <script src="js/all.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
</body>
</html>
